<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>swagon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="RunLoop参考文章
http://www.dreamingwish.com/article/ios-multithread-program-runloop-the.html

tips
CGD中Dispatch到 main queue的block被分发到main runLoop中执行；

事件处理的循环,用来不停的调度工作以及处理输入事件。使用run loop的目的是让你的线程在有工作的时候忙">
<meta property="og:type" content="article">
<meta property="og:title" content="swagon">
<meta property="og:url" content="yoursite.com/2016/03/03/runloop/index.html">
<meta property="og:site_name" content="swagon">
<meta property="og:description" content="RunLoop参考文章
http://www.dreamingwish.com/article/ios-multithread-program-runloop-the.html

tips
CGD中Dispatch到 main queue的block被分发到main runLoop中执行；

事件处理的循环,用来不停的调度工作以及处理输入事件。使用run loop的目的是让你的线程在有工作的时候忙">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="swagon">
<meta name="twitter:description" content="RunLoop参考文章
http://www.dreamingwish.com/article/ios-multithread-program-runloop-the.html

tips
CGD中Dispatch到 main queue的block被分发到main runLoop中执行；

事件处理的循环,用来不停的调度工作以及处理输入事件。使用run loop的目的是让你的线程在有工作的时候忙">
  
    <link rel="alternative" href="/atom.xml" title="swagon" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">swagon</a></h1>
		</hgroup>

		
		<p class="header-subtitle">原谅我不堪回首的过去</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="/#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">swagon</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">swagon</h1>
			</hgroup>
			
			<p class="header-subtitle">原谅我不堪回首的过去</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="/#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-runloop" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/03/runloop/" class="article-date">
  	<time datetime="2016-03-03T04:21:34.000Z" itemprop="datePublished">3月 3 2016</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="RunLoop">RunLoop</h1><h3 id="参考文章">参考文章</h3><ol>
<li><a href="http://www.dreamingwish.com/article/ios-multithread-program-runloop-the.html" target="_blank" rel="external">http://www.dreamingwish.com/article/ios-multithread-program-runloop-the.html</a></li>
</ol>
<h3 id="tips">tips</h3><ol>
<li><p>CGD中Dispatch到 main queue的block被分发到main runLoop中执行；</p>
</li>
<li><p>事件处理的循环,用来不停的调度工作以及处理输入事件。使用run loop的目的是让你的线程在有工作的时候忙于工作，而没工作的时候处于休眠状态。每个线程有与之对应的runloop，只有辅助线程才需要显式的运行它的run loop</p>
</li>
<li><p>两种源input sourece和time source <a href="http://www.dreamingwish.com/article/ios-multithread-program-runloop-the.html" target="_blank" rel="external">地址</a>     </p>
<ol>
<li><p>输入源传递异步事件，通常消息来自于其他线程或程序。并调用runUntilDate:方法来退出(在线程里面相关的NSRunLoop对象调用)。</p>
<ul>
<li>基于端口的输入源<ul>
<li>在Cocoa里面你从来不需要直接创建输入源。你只要简单的创建端口对象，并使用NSPort的方法把该端口添加到run loop。端口对象会自己处理创建和配置输入源。</li>
</ul>
</li>
<li>自定义的输入源<ul>
<li>除了定义在事件到达时自定义输入源的行为，你也必须定义消息传递机制。</li>
<li>为了创建自定义输入源，必须使用Core Foundation里面的CFRunLoopSourceRef类型相关的函数来创建。你可以使用回调函数来配置自定义输入源。Core Fundation会在配置源的不同地方调用回调函数，处理输入事件，在源从run loop移除的时候清理它。</li>
</ul>
</li>
<li>区别：基于端口的输入源由内核自动发送，而自定义的则需要人工从其他线程发送。</li>
<li>若某一源在当前模式下不被监听，那么任何其生成的消息只在run loop运行在其关联的模式下才会被传递。</li>
<li><strong>Cocoa </strong>执行 Selector 的源</li>
</ul>
<p>​</p>
</li>
<li><p>定时源则传递同步事件，发生在特定时间或者重复的时间间隔。</p>
<ol>
<li>定时器所在的模式当前未被run loop监视，那么定时器将不会开始直到run loop运行在相应的模式下。</li>
</ol>
</li>
<li><p>两种源都使用程序的某一特定的处理例程来处理到达的事件。</p>
</li>
<li><p>定时源则直接传递消息给处理例程，但并不会退出run loop。 </p>
</li>
<li><p>除了处理输入源，run loops也会生成关于run loop行为的通知(notifications)。注册的run loop观察者(run-loop Observers)可以收到这些通知，并在线程上面使用它们来做额外的处理。你可以使用Core Foundation在你的线程注册run-loop观察者。</p>
</li>
</ol>
</li>
<li><p>run-loop观察者</p>
<ol>
<li>源是合适的同步或异步事件发生时触发，而run loop观察者则是在run loop本身运行的<strong>特定时候</strong>触发。你可以使用run loop观察者来为处理某一特定事件或是进入休眠的线程做准备</li>
<li>定时器类似，run loop观察者可以只用一次或循环使用。</li>
</ol>
</li>
<li><p>runloop事件队列</p>
<ol>
<li>每次运行run loop，你线程的run loop对会自动处理之前未处理的消息，并通知相关的观察者。具体的顺序如下：<ol>
<li>通知观察者run loop已经启动</li>
<li>通知观察者任何即将要开始的定时器</li>
<li>通知观察者任何即将启动的非基于端口的源</li>
<li>启动任何准备好的非基于端口的源</li>
<li>如果基于端口的源准备好并处于等待状态，立即启动；并进入步骤9。</li>
<li>通知观察者线程进入休眠</li>
<li>将线程置于休眠直到任一下面的事件发生：<ul>
<li>某一事件到达基于端口的源</li>
<li>定时器启动</li>
<li>Run loop设置的时间已经超时</li>
<li>run loop被显式唤醒</li>
</ul>
</li>
<li>通知观察者线程将被唤醒。</li>
<li>处理未处理的事件<ul>
<li>如果用户定义的定时器启动，处理定时器事件并重启run loop。进入步骤2</li>
<li>如果输入源启动，传递相应的消息</li>
<li>如果run loop被显式唤醒而且时间还没超时，重启run loop。进入步骤2</li>
</ul>
</li>
<li>通知观察者run loop结束。</li>
</ol>
</li>
<li>​</li>
</ol>
<p>​</p>
</li>
<li><p>runloop模式</p>
<ul>
<li><p>Run loop模式是所有要监视的输入源和定时源以及要通知的run loop注册观察者的集合。</p>
</li>
<li><p>每次运行你的run loop，你都要指定（无论显示还是隐式）其运行个模式。</p>
</li>
<li><p>大多数时候，run loop都是运行在系统定义的默认模式上。但是模态面板（modal panel）可以运行在 “modal”模式下。</p>
</li>
<li><p><em>模式区分基于事件的源而非事件的种类。例如，你不可以使用模式只选择处理鼠标按下或者键盘事件。你可以使用模式监听端口，暂停定时器或者改变其他源或者当前模式下处于监听状态run loop观察者。</em></p>
</li>
<li><p>| Mode           | Name                                     | Description                              |<br>| ——————— | ———————————————————— | ———————————————————— |<br>| Default        | <a href="http://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSRunLoop_Class/Reference/Reference.html#//apple_ref/c/data/NSDefaultRunLoopMode" target="_blank" rel="external">NSDefaultRunLoopMode</a>(Cocoa)<a href="http://developer.apple.com/library/ios/documentation/CoreFoundation/Reference/CFRunLoopRef/Reference/reference.html#//apple_ref/c/data/kCFRunLoopDefaultMode" target="_blank" rel="external">kCFRunLoopDefaultMode</a> (Core Foundation) | The default mode is the one used for most operations. Most of the time, you should use this mode to start your run loop and configure your input sources. |<br>| Connection     | NSConnectionReplyMode(Cocoa)             | Cocoa uses this mode in conjunction with NSConnection objects to monitor replies. You should rarely need to use this mode yourself. |<br>| Modal          | NSModalPanelRunLoopMode(Cocoa)           | Cocoa uses this mode to identify events intended for modal panels. |<br>| Event tracking | NSEventTrackingRunLoopMode(Cocoa)        | Cocoa uses this mode to restrict incoming events during mouse-dragging loops and other sorts of user interface tracking loops. |<br>| Common modes   | <a href="http://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSRunLoop_Class/Reference/Reference.html#//apple_ref/c/data/NSRunLoopCommonModes" target="_blank" rel="external">NSRunLoopCommonModes</a>(Cocoa)<a href="http://developer.apple.com/library/ios/documentation/CoreFoundation/Reference/CFRunLoopRef/Reference/reference.html#//apple_ref/c/data/kCFRunLoopCommonModes" target="_blank" rel="external">kCFRunLoopCommonModes</a> (Core Foundation) | This is a configurable group of commonly used modes. Associating an input source with this mode also associates it with each of the modes in the group. For Cocoa applications, this set includes the default, modal, and event tracking modes by default. Core Foundation includes just the default mode initially. You can add custom modes to the set using the <a href="http://developer.apple.com/library/ios/documentation/CoreFoundation/Reference/CFRunLoopRef/Reference/reference.html#//apple_ref/c/func/CFRunLoopAddCommonMode" target="_blank" rel="external">CFRunLoopAddCommonMode</a> function. |</p>
<p>​</p>
</li>
</ul>
<p>​</p>
</li>
<li><p>mach_port端口</p>
</li>
<li><p>NSDelayPerforming</p>
</li>
<li><p>AFNetworking [runLoop addPort]</p>
</li>
<li><p>优化TableView加载图片 delegate -&gt;<code>[self.avatarImageView performSlector:@selector(setImage:) afterDelay:0 inModels:[NSDefaultRunLoopMode]]</code> </p>
</li>
<li><p>GCD源码 libdispatch  内核  <code>mac_vm_size_t</code></p>
</li>
<li><p>CoreFoundation</p>
</li>
<li><p>setNeedsDisplay然后向等待重绘的视图发送DrawRect消息</p>
</li>
<li><p>不重绘没有改变的视图，自定义的消息要手动调用SetNeedsDisplay   </p>
</li>
<li><p>只绘制一个区域SetNeedsDisplayInRect</p>
</li>
<li><p>视图属性为nil默认会调用loadView方法</p>
</li>
<li><p>loadView能够自动处理nib文件包含的视图层次结构</p>
</li>
</ol>
<h3 id="Event_Loop">Event Loop</h3><p>function loop() {</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">initialize();</span><br><span class="line">do &#123;</span><br><span class="line">    var <span class="keyword">message</span> = get_next_message();</span><br><span class="line">    process_message(<span class="keyword">message</span>);</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="keyword">message</span> != quit);</span><br></pre></td></tr></table></figure>
<p>}</p>
<p>CFRunLoopRef 是在 CoreFoundation 框架内的，它提供了纯 C 函数的 API，所有这些 API 都是线程安全的。</p>
<p>NSRunLoop 是基于 CFRunLoopRef 的封装，提供了面向对象的 API，但是这些 API 不是线程安全的。</p>
<p>从上面的代码可以看出，线程和 RunLoop 之间是一一对应的，其关系是保存在一个全局的 Dictionary 里。线程刚创建时并没有 RunLoop，如果你不主动获取，那它一直都不会有。RunLoop 的创建是发生在第一次获取时，RunLoop 的销毁是发生在线程结束时。你只能在一个线程的内部获取其 RunLoop（主线程除外）。</p>
<p><strong>CFRunLoopSourceRef</strong> 是事件产生的地方。Source有两个版本：Source0 和 Source1。</p>
<p>Source0 只包含了一个回调（函数指针），它并不能主动触发事件。使用时，你需要先调用 CFRunLoopSourceSignal(source)，将这个 Source 标记为待处理，然后手动调用 CFRunLoopWakeUp(runloop) 来唤醒 RunLoop，让其处理这个事件</p>
<p>Source1 包含了一个 mach_port 和一个回调（函数指针），被用于通过内核和其他线程相互发送消息。这种 Source 能主动唤醒 RunLoop 的线程，其原理在下面会讲到。</p>
<p><strong>CFRunLoopTimerRef</strong> 是基于时间的触发器，它和 NSTimer 是toll-free bridged 的，可以混用。其包含一个时间长度和一个回调（函数指针）。当其加入到 RunLoop 时，RunLoop会注册对应的时间点，当时间点到时，RunLoop会被唤醒以执行那个回调。</p>
<p><strong>CFRunLoopObserverRef</strong> 是观察者，每个 Observer 都包含了一个回调（函数指针），当 RunLoop 的状态发生变化时，观察者就能通过回调接受到这个变化。可以观测的时间点有以下几个：</p>
<p>typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kCFRunLoopEntry         = (<span class="number">1U</span>L &lt;&lt; <span class="number">0</span>), <span class="comment">// 即将进入Loop</span></span><br><span class="line">kCFRunLoopBeforeTimers  = (<span class="number">1U</span>L &lt;&lt; <span class="number">1</span>), <span class="comment">// 即将处理 Timer</span></span><br><span class="line">kCFRunLoopBeforeSources = (<span class="number">1U</span>L &lt;&lt; <span class="number">2</span>), <span class="comment">// 即将处理 Source</span></span><br><span class="line">kCFRunLoopBeforeWaiting = (<span class="number">1U</span>L &lt;&lt; <span class="number">5</span>), <span class="comment">// 即将进入休眠</span></span><br><span class="line">kCFRunLoopAfterWaiting  = (<span class="number">1U</span>L &lt;&lt; <span class="number">6</span>), <span class="comment">// 刚从休眠中唤醒</span></span><br><span class="line">kCFRunLoopExit          = (<span class="number">1U</span>L &lt;&lt; <span class="number">7</span>), <span class="comment">// 即将退出Loop</span></span><br></pre></td></tr></table></figure>
<p>};</p>
<p>上面的 Source/Timer/Observer 被统称为 mode item，一个 item 可以被同时加入多个 mode。但一个 item 被重复加入同一个 mode 时是不会有效果的。如果一个 mode 中一个 item 都没有，则 RunLoop 会直接退出，不进入循环。</p>
<p>RunLoop 的核心就是一个 mach_msg() </p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/03/04/pop/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2016/03/03/多线程和内存管理(书)/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title"></div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="runloop" data-title="" data-url="yoursite.com/2016/03/03/runloop/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 swagon
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/mobile.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>